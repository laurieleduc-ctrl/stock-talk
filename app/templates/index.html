{% extends "base.html" %}

{% block title %}Stock Talk - Today's Value Picks{% endblock %}

{% block content %}
<div x-data="reportData()" x-init="loadLatestReport()">
    <!-- Loading state -->
    <div x-show="loading" class="flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>

    <!-- Error state -->
    <div x-show="error && !loading" class="text-center py-20">
        <div class="text-6xl mb-4">üìä</div>
        <h2 class="text-2xl font-bold text-white mb-2">No Report Available</h2>
        <p class="text-dark-400 mb-6" x-text="error"></p>
        <button
            @click="generateReport()"
            :disabled="generating"
            class="px-6 py-3 rounded-lg text-base font-medium transition-colors bg-green-700 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2"
        >
            <span x-show="!generating">Generate New Report</span>
            <span x-show="generating" class="flex items-center gap-2">
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generating...
            </span>
        </button>
        <!-- Generation status message -->
        <div x-show="generateMessage" x-cloak class="mt-6 mx-auto max-w-md p-4 rounded-lg bg-blue-900/30 border border-blue-700/50">
            <div class="flex items-center justify-center gap-3">
                <svg x-show="generating" class="animate-spin h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-blue-300" x-text="generateMessage"></span>
            </div>
        </div>
    </div>

    <!-- Report content -->
    <div x-show="report && !loading" x-cloak>
        <!-- Header -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white">Today's Value Picks</h1>
                    <p class="text-dark-400 mt-1">
                        <span x-text="formatDate(report?.date)"></span>
                        <span x-show="report?.created_at" class="text-dark-500">
                            ‚Ä¢ Generated <span x-text="formatTimestamp(report?.created_at)"></span>
                        </span>
                        ‚Ä¢ <span x-text="report?.stocks?.length"></span> stocks selected from
                        <span x-text="report?.stocks_analyzed"></span> analyzed
                    </p>
                </div>
                <div class="mt-4 md:mt-0 flex flex-wrap gap-2">
                    <button
                        @click="viewMode = 'cards'"
                        :class="viewMode === 'cards' ? 'bg-blue-600' : 'bg-dark-800'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                    >
                        Cards
                    </button>
                    <button
                        @click="viewMode = 'table'"
                        :class="viewMode === 'table' ? 'bg-blue-600' : 'bg-dark-800'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                    >
                        Table
                    </button>
                    <button
                        @click="generateReport()"
                        :disabled="generating"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-green-700 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                    >
                        <span x-show="!generating">Generate New Report</span>
                        <span x-show="generating" class="flex items-center gap-2">
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Generating...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Generation status message -->
        <div x-show="generateMessage" x-cloak class="mb-6 p-4 rounded-lg bg-blue-900/30 border border-blue-700/50">
            <div class="flex items-center gap-3">
                <svg x-show="generating" class="animate-spin h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-blue-300" x-text="generateMessage"></span>
            </div>
        </div>

        <!-- Market Context -->
        <div x-show="report?.market_summary || report?.market_news?.length" class="bg-dark-900 rounded-lg border border-dark-800 mb-8 overflow-hidden">
            <!-- Index performance bar -->
            <div class="flex flex-wrap items-center gap-x-6 gap-y-2 px-5 py-3 border-b border-dark-800 text-sm">
                <span class="text-dark-400 font-medium">Markets:</span>
                <template x-if="report?.sp500_change != null">
                    <span>
                        <span class="text-dark-400">S&P 500</span>
                        <span :class="report.sp500_change >= 0 ? 'text-green-400' : 'text-red-400'" x-text="(report.sp500_change >= 0 ? '+' : '') + report.sp500_change.toFixed(2) + '%'"></span>
                    </span>
                </template>
                <template x-if="report?.nasdaq_change != null">
                    <span>
                        <span class="text-dark-400">Nasdaq</span>
                        <span :class="report.nasdaq_change >= 0 ? 'text-green-400' : 'text-red-400'" x-text="(report.nasdaq_change >= 0 ? '+' : '') + report.nasdaq_change.toFixed(2) + '%'"></span>
                    </span>
                </template>
                <template x-if="report?.dow_change != null">
                    <span>
                        <span class="text-dark-400">Dow</span>
                        <span :class="report.dow_change >= 0 ? 'text-green-400' : 'text-red-400'" x-text="(report.dow_change >= 0 ? '+' : '') + report.dow_change.toFixed(2) + '%'"></span>
                    </span>
                </template>
                <template x-if="report?.vix_level != null">
                    <span>
                        <span class="text-dark-400">VIX</span>
                        <span :class="report.vix_level > 25 ? 'text-red-400' : (report.vix_level < 15 ? 'text-green-400' : 'text-yellow-400')" x-text="report.vix_level.toFixed(1)"></span>
                    </span>
                </template>
            </div>
            <!-- News headlines -->
            <div x-show="report?.market_news?.length" class="px-5 py-3">
                <div class="space-y-2">
                    <template x-for="(item, idx) in report?.market_news || []" :key="idx">
                        <div class="flex items-start gap-2 text-sm">
                            <span class="text-dark-600 mt-0.5 shrink-0">&bull;</span>
                            <div class="min-w-0">
                                <a :href="item.url" target="_blank" rel="noopener noreferrer" class="text-dark-200 hover:text-blue-400 transition-colors" x-text="item.title"></a>
                                <span x-show="item.source" class="text-dark-600 ml-1" x-text="'(' + item.source + ')'"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Sector breakdown -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <template x-for="(count, sector) in report?.sector_breakdown" :key="sector">
                <div class="bg-dark-900 rounded-lg p-4 border border-dark-800">
                    <div class="text-2xl font-bold text-white" x-text="count"></div>
                    <div class="text-sm text-dark-400 capitalize" x-text="sector === 'ai' ? 'AI' : sector"></div>
                </div>
            </template>
        </div>

        <!-- Tip of the day -->
        <div x-show="report?.tip_of_the_day" class="bg-gradient-to-r from-blue-900/50 to-purple-900/50 rounded-lg p-6 mb-8 border border-blue-800/50">
            <div class="flex items-start space-x-4">
                <div class="text-3xl">üí°</div>
                <div>
                    <h3 class="text-lg font-semibold text-white" x-text="report?.tip_of_the_day?.title"></h3>
                    <p class="text-dark-300 mt-2" x-text="report?.tip_of_the_day?.content"></p>
                </div>
            </div>
        </div>

        <!-- Comparison table view -->
        <div x-show="viewMode === 'table'" class="overflow-x-auto mb-8">
            <table class="w-full text-sm">
                <thead class="bg-dark-900 text-dark-400">
                    <tr>
                        <th @click="sortBy('rank')" class="px-4 py-3 text-left cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center"># <span x-show="sortColumn === 'rank'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('ticker')" class="px-4 py-3 text-left cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center">Stock <span x-show="sortColumn === 'ticker'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('price')" class="px-4 py-3 text-right cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end">Price <span x-show="sortColumn === 'price'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('pct_from_ath')" class="px-4 py-3 text-right cursor-pointer hover:text-white transition-colors" title="% below the 3-year high price">
                            <span class="flex items-center justify-end">% Off 3Y High <span x-show="sortColumn === 'pct_from_ath'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('pe_ratio')" class="px-4 py-3 text-right cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end">P/E <span x-show="sortColumn === 'pe_ratio'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('forward_pe')" class="px-4 py-3 text-right cursor-pointer hover:text-white transition-colors hidden lg:table-cell">
                            <span class="flex items-center justify-end">Fwd P/E <span x-show="sortColumn === 'forward_pe'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('rsi')" class="px-4 py-3 text-right cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end">RSI <span x-show="sortColumn === 'rsi'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('three_month_return')" class="px-4 py-3 text-right cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end">3M Return <span x-show="sortColumn === 'three_month_return'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('one_year_return')" class="px-4 py-3 text-right cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-end">1Y Return <span x-show="sortColumn === 'one_year_return'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('sentiment_label')" class="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors">
                            <span class="flex items-center justify-center">Sentiment <span x-show="sortColumn === 'sentiment_label'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                        <th @click="sortBy('bullish_signals')" class="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" title="Bullish signals / Bearish signals based on: RSI, P/E, PEG, Debt, FCF, Short Interest, and Insider Activity">
                            <span class="flex items-center justify-center">Signals <span x-show="sortColumn === 'bullish_signals'" x-text="sortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº'" class="ml-1 text-blue-400"></span></span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-dark-800">
                    <template x-for="stock in sortedStocks" :key="stock.ticker">
                        <tr
                            class="hover:bg-dark-900 cursor-pointer"
                            :class="stock.is_dark_horse ? 'bg-purple-900/20' : ''"
                            @click="window.location.href = '/stock/' + stock.ticker"
                        >
                            <td class="px-4 py-3">
                                <span x-text="stock.rank"></span>
                                <span x-show="stock.is_dark_horse" class="ml-1 cursor-help" :title="stock.dark_horse_reasons?.join('; ') || 'Under-the-radar opportunity'">üê¥</span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="font-semibold text-white cursor-help" :title="stock.business_summary || stock.name" x-text="stock.ticker"></div>
                                <div class="text-dark-500 text-xs truncate max-w-[150px] cursor-help" :title="stock.business_summary || stock.name" x-text="stock.name"></div>
                            </td>
                            <td class="px-4 py-3 text-right font-mono" x-text="'$' + stock.price?.toFixed(2)"></td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-red-400" x-text="'-' + stock.pct_from_ath?.toFixed(1) + '%'"></span>
                            </td>
                            <td class="px-4 py-3 text-right" x-text="stock.pe_ratio?.toFixed(1) || 'N/A'"></td>
                            <td class="px-4 py-3 text-right hidden lg:table-cell" x-text="stock.forward_pe?.toFixed(1) || 'N/A'"></td>
                            <td class="px-4 py-3 text-right">
                                <span :class="stock.rsi < 30 ? 'text-green-400' : (stock.rsi > 70 ? 'text-red-400' : '')" x-text="stock.rsi?.toFixed(0) || 'N/A'"></span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span :class="stock.three_month_return > 0 ? 'text-green-400' : 'text-red-400'" x-text="stock.three_month_return != null ? ((stock.three_month_return > 0 ? '+' : '') + stock.three_month_return?.toFixed(1) + '%') : 'N/A'"></span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span :class="stock.one_year_return > 0 ? 'text-green-400' : 'text-red-400'" x-text="stock.one_year_return != null ? ((stock.one_year_return > 0 ? '+' : '') + stock.one_year_return?.toFixed(1) + '%') : 'N/A'"></span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span
                                    class="px-2 py-1 rounded text-xs font-medium"
                                    :class="{
                                        'bg-green-900/50 text-green-400': stock.sentiment_label === 'Bullish',
                                        'bg-red-900/50 text-red-400': stock.sentiment_label === 'Bearish',
                                        'bg-dark-700 text-dark-300': stock.sentiment_label === 'Mixed'
                                    }"
                                    x-text="stock.sentiment_label"
                                ></span>
                            </td>
                            <td class="px-4 py-3 text-center cursor-help" title="Green = bullish signals, Red = bearish signals. Based on: RSI (<30 bullish, >70 bearish), P/E (<15 bullish, >30 bearish), PEG (<1 bullish, >2 bearish), Debt/Equity (<0.5 bullish, >1.5 bearish), Free Cash Flow (positive bullish), Short Interest (>20% bearish), Insider buying/selling">
                                <span class="text-green-400" x-text="stock.bullish_signals"></span>
                                <span class="text-dark-600">/</span>
                                <span class="text-red-400" x-text="stock.bearish_signals"></span>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Cards view -->
        <div x-show="viewMode === 'cards'" class="space-y-6">
            <template x-for="stock in report?.stocks" :key="stock.ticker">
                <div
                    class="stock-card"
                    :class="stock.is_dark_horse ? 'dark-horse' : ''"
                >
                    <!-- Card header -->
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-dark-500" x-text="'#' + stock.rank"></span>
                                <span x-show="stock.is_dark_horse" class="text-sm">üê¥ Dark Horse</span>
                            </div>
                            <h3 class="text-xl font-bold text-white mt-1">
                                <a :href="'/stock/' + stock.ticker" class="hover:text-blue-400" x-text="stock.ticker"></a>
                                <span class="text-dark-400 font-normal text-base ml-2 cursor-help" :title="stock.business_summary || 'No description available'" x-text="stock.name"></span>
                            </h3>
                            <div class="text-sm text-dark-500 mt-1">
                                <span x-text="stock.sector"></span> ‚Ä¢
                                <span class="capitalize" x-text="stock.sector_category === 'ai' ? 'AI' : stock.sector_category"></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-white" x-text="'$' + stock.price?.toFixed(2)"></div>
                            <div class="text-red-400 font-medium" x-text="stock.pct_from_ath?.toFixed(1) + '% off 3Y high'"></div>
                        </div>
                    </div>

                    <!-- Key Metrics grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="metric-box">
                            <div class="metric-label">P/E Ratio</div>
                            <div class="metric-value" x-text="stock.pe_ratio?.toFixed(1) || 'N/A'"></div>
                            <div class="text-xs text-dark-500">
                                <span x-show="stock.forward_pe" x-text="'Fwd: ' + stock.forward_pe?.toFixed(1)"></span>
                                <span x-show="stock.pe_ratio && report?.sector_averages?.[stock.sector]?.pe" class="ml-1" :class="stock.pe_ratio < report.sector_averages[stock.sector].pe ? 'text-green-500' : 'text-red-500'" x-text="stock.pe_ratio < report.sector_averages[stock.sector]?.pe ? '‚ñº sector' : '‚ñ≤ sector'"></span>
                            </div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">P/B Ratio</div>
                            <div class="metric-value" :class="stock.pb_ratio != null && stock.pb_ratio < 1 ? 'text-green-400' : ''" x-text="stock.pb_ratio?.toFixed(2) || 'N/A'"></div>
                            <div class="metric-help">Price vs assets</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Debt/Equity</div>
                            <div class="metric-value" :class="stock.debt_to_equity != null ? (stock.debt_to_equity < 0.5 ? 'text-green-400' : (stock.debt_to_equity > 1.5 ? 'text-red-400' : 'text-yellow-400')) : ''" x-text="stock.debt_to_equity?.toFixed(2) || 'N/A'"></div>
                            <div class="metric-help">Lower = less risk</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Free Cash Flow</div>
                            <div class="metric-value" :class="stock.free_cash_flow != null ? (stock.free_cash_flow > 0 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.free_cash_flow != null ? '$' + stock.free_cash_flow?.toFixed(1) + 'B' : 'N/A'"></div>
                            <div class="metric-help">Cash generated</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">RSI</div>
                            <div class="metric-value" :class="stock.rsi != null ? (stock.rsi < 30 ? 'text-green-400' : (stock.rsi > 70 ? 'text-red-400' : '')) : ''" x-text="stock.rsi?.toFixed(0) || 'N/A'"></div>
                            <div class="metric-help" x-text="stock.rsi != null ? (stock.rsi < 30 ? 'Oversold' : (stock.rsi > 70 ? 'Overbought' : 'Neutral')) : ''"></div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">1M Return</div>
                            <div class="metric-value" :class="stock.one_month_return != null ? (stock.one_month_return > 0 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.one_month_return != null ? ((stock.one_month_return > 0 ? '+' : '') + stock.one_month_return?.toFixed(1) + '%') : 'N/A'"></div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">3M Return</div>
                            <div class="metric-value" :class="stock.three_month_return != null ? (stock.three_month_return > 0 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.three_month_return != null ? ((stock.three_month_return > 0 ? '+' : '') + stock.three_month_return?.toFixed(1) + '%') : 'N/A'"></div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">1Y Return</div>
                            <div class="metric-value" :class="stock.one_year_return != null ? (stock.one_year_return > 0 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.one_year_return != null ? ((stock.one_year_return > 0 ? '+' : '') + stock.one_year_return?.toFixed(1) + '%') : 'N/A'"></div>
                        </div>
                    </div>

                    <!-- Expandable Advanced Metrics -->
                    <div x-data="{ expanded: false }" class="mb-4">
                        <button @click="expanded = !expanded" class="flex items-center gap-2 text-sm text-dark-400 hover:text-dark-200 transition-colors mb-2">
                            <svg :class="expanded ? 'rotate-90' : ''" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            Advanced Metrics
                        </button>
                        <div x-show="expanded" x-transition>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="metric-box">
                                    <div class="metric-label">P/S Ratio</div>
                                    <div class="metric-value" x-text="stock.ps_ratio?.toFixed(1) || 'N/A'"></div>
                                    <div class="metric-help">Price vs revenue</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">EV/EBITDA</div>
                                    <div class="metric-value" :class="stock.ev_ebitda != null ? (stock.ev_ebitda < 10 ? 'text-green-400' : (stock.ev_ebitda > 25 ? 'text-red-400' : '')) : ''" x-text="stock.ev_ebitda?.toFixed(1) || 'N/A'"></div>
                                    <div class="metric-help">Enterprise value ratio</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">PEG Ratio</div>
                                    <div class="metric-value" :class="stock.peg_ratio != null ? (stock.peg_ratio < 1 ? 'text-green-400' : (stock.peg_ratio > 2 ? 'text-red-400' : '')) : ''" x-text="stock.peg_ratio?.toFixed(2) || 'N/A'"></div>
                                    <div class="metric-help">&lt;1 = undervalued growth</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Current Ratio</div>
                                    <div class="metric-value" :class="stock.current_ratio != null ? (stock.current_ratio > 1.5 ? 'text-green-400' : (stock.current_ratio < 1 ? 'text-red-400' : 'text-yellow-400')) : ''" x-text="stock.current_ratio?.toFixed(2) || 'N/A'"></div>
                                    <div class="metric-help">Liquidity health</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Gross Margin</div>
                                    <div class="metric-value" :class="stock.gross_margin != null ? (stock.gross_margin > 50 ? 'text-green-400' : (stock.gross_margin < 20 ? 'text-red-400' : '')) : ''" x-text="stock.gross_margin != null ? stock.gross_margin?.toFixed(1) + '%' : 'N/A'"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Operating Margin</div>
                                    <div class="metric-value" :class="stock.operating_margin != null ? (stock.operating_margin > 20 ? 'text-green-400' : (stock.operating_margin < 0 ? 'text-red-400' : '')) : ''" x-text="stock.operating_margin != null ? stock.operating_margin?.toFixed(1) + '%' : 'N/A'"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Profit Margin</div>
                                    <div class="metric-value" :class="stock.profit_margin != null ? (stock.profit_margin > 15 ? 'text-green-400' : (stock.profit_margin < 0 ? 'text-red-400' : '')) : ''" x-text="stock.profit_margin != null ? stock.profit_margin?.toFixed(1) + '%' : 'N/A'"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">YTD Return</div>
                                    <div class="metric-value" :class="stock.ytd_return != null ? (stock.ytd_return > 0 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.ytd_return != null ? ((stock.ytd_return > 0 ? '+' : '') + stock.ytd_return?.toFixed(1) + '%') : 'N/A'"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Short Interest</div>
                                    <div class="metric-value" :class="stock.short_interest != null ? (stock.short_interest > 20 ? 'text-red-400' : (stock.short_interest > 10 ? 'text-yellow-400' : 'text-green-400')) : ''" x-text="stock.short_interest != null ? stock.short_interest?.toFixed(1) + '%' : 'N/A'"></div>
                                    <div class="metric-help">% shorted</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Dividend</div>
                                    <div class="metric-value" x-text="stock.dividend_yield ? stock.dividend_yield?.toFixed(2) + '%' : 'None'"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Earnings Surprise</div>
                                    <div class="metric-value" :class="stock.earnings_surprise_pct != null ? (stock.earnings_surprise_pct > 0 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.earnings_surprise_pct != null ? ((stock.earnings_surprise_pct > 0 ? '+' : '') + stock.earnings_surprise_pct?.toFixed(1) + '%') : 'N/A'"></div>
                                    <div class="metric-help">Last quarter</div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">50-Day MA</div>
                                    <div class="metric-value" :class="stock.sma_50 && stock.price ? (stock.price > stock.sma_50 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.sma_50 ? '$' + stock.sma_50?.toFixed(2) : 'N/A'"></div>
                                    <div class="metric-help" x-text="stock.sma_50 && stock.price ? (stock.price > stock.sma_50 ? 'Price above' : 'Price below') : ''"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">200-Day MA</div>
                                    <div class="metric-value" :class="stock.sma_200 && stock.price ? (stock.price > stock.sma_200 ? 'text-green-400' : 'text-red-400') : ''" x-text="stock.sma_200 ? '$' + stock.sma_200?.toFixed(2) : 'N/A'"></div>
                                    <div class="metric-help" x-text="stock.sma_200 && stock.sma_50 ? (stock.sma_50 > stock.sma_200 ? 'Golden cross' : 'Death cross') : ''"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Volume</div>
                                    <div class="metric-value" :class="stock.avg_volume && stock.recent_volume ? (stock.recent_volume > stock.avg_volume * 1.5 ? 'text-yellow-400' : '') : ''" x-text="stock.recent_volume ? formatVolume(stock.recent_volume) : 'N/A'"></div>
                                    <div class="metric-help" x-text="stock.avg_volume && stock.recent_volume ? (stock.recent_volume > stock.avg_volume * 1.5 ? 'HIGH vs avg ' + formatVolume(stock.avg_volume) : 'Avg: ' + formatVolume(stock.avg_volume)) : ''"></div>
                                </div>
                                <div class="metric-box">
                                    <div class="metric-label">Insider Own.</div>
                                    <div class="metric-value" x-text="stock.insider_ownership != null ? stock.insider_ownership?.toFixed(1) + '%' : 'N/A'"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 52-week range -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-dark-500 mb-1">
                            <span>52-Week Range</span>
                            <span x-text="'$' + stock.fifty_two_week_low?.toFixed(2) + ' - $' + stock.fifty_two_week_high?.toFixed(2)"></span>
                        </div>
                        <div class="h-2 bg-dark-700 rounded-full overflow-hidden">
                            <div
                                class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full relative"
                                style="width: 100%"
                            >
                                <div
                                    class="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full border-2 border-dark-900"
                                    :style="'left: ' + (stock.week_52_position || 50) + '%'"
                                ></div>
                            </div>
                        </div>
                    </div>

                    <!-- Sentiment & Analyst -->
                    <div class="flex flex-wrap gap-4 mb-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-dark-500">Reddit:</span>
                            <span
                                class="px-2 py-1 rounded text-xs font-medium"
                                :class="{
                                    'bg-green-900/50 text-green-400': stock.sentiment_label === 'Bullish',
                                    'bg-red-900/50 text-red-400': stock.sentiment_label === 'Bearish',
                                    'bg-dark-700 text-dark-300': stock.sentiment_label === 'Mixed'
                                }"
                                x-text="stock.sentiment_label + ' (' + stock.reddit_mentions + ' mentions)'"
                            ></span>
                        </div>
                        <div x-show="stock.analyst_rating" class="flex items-center space-x-2">
                            <span class="text-dark-500">Analysts:</span>
                            <span class="capitalize" x-text="stock.analyst_rating"></span>
                            <span x-show="stock.target_upside_pct" :class="stock.target_upside_pct > 0 ? 'text-green-400' : 'text-red-400'" x-text="'(' + (stock.target_upside_pct > 0 ? '+' : '') + stock.target_upside_pct?.toFixed(0) + '%)'"></span>
                            <span x-show="stock.target_price_low && stock.target_price_high" class="text-dark-500 text-xs" x-text="'$' + stock.target_price_low?.toFixed(0) + '-$' + stock.target_price_high?.toFixed(0)"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-dark-500">Signals:</span>
                            <span class="text-green-400" x-text="stock.bullish_signals + ' bullish'"></span>
                            <span class="text-dark-600">/</span>
                            <span class="text-red-400" x-text="stock.bearish_signals + ' bearish'"></span>
                        </div>
                    </div>

                    <!-- Buy case -->
                    <div class="bg-dark-800/50 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-green-400 mb-2">üí° Why It Might Be a Buy</h4>
                        <p class="text-dark-300 text-sm" x-text="stock.buy_case"></p>
                    </div>

                    <!-- Risk factors with severity indicators -->
                    <div class="bg-dark-800/50 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-red-400 mb-2">‚ö†Ô∏è Risks to Know</h4>
                        <ul class="text-dark-300 text-sm space-y-2">
                            <template x-for="(risk, idx) in stock.risk_factors" :key="risk">
                                <li class="flex items-start gap-2">
                                    <span
                                        class="mt-0.5 shrink-0 w-2 h-2 rounded-full"
                                        :class="idx === 0 ? 'bg-red-500' : (idx === 1 ? 'bg-orange-500' : 'bg-yellow-500')"
                                    ></span>
                                    <span x-text="risk"></span>
                                </li>
                            </template>
                        </ul>
                    </div>

                    <!-- Dark horse reasons -->
                    <div x-show="stock.is_dark_horse && stock.dark_horse_reasons?.length" class="bg-purple-900/30 rounded-lg p-4 mb-4 border border-purple-800/50">
                        <h4 class="text-sm font-semibold text-purple-400 mb-2">üê¥ Why It's Under the Radar</h4>
                        <ul class="text-dark-300 text-sm space-y-1">
                            <template x-for="reason in stock.dark_horse_reasons" :key="reason">
                                <li class="flex items-start">
                                    <span class="text-dark-600 mr-2">‚Ä¢</span>
                                    <span x-text="reason"></span>
                                </li>
                            </template>
                        </ul>
                    </div>

                    <!-- Recent news -->
                    <div x-show="stock.recent_news?.length" class="border-t border-dark-800 pt-4">
                        <h4 class="text-sm font-semibold text-dark-400 mb-2">üì∞ Recent News</h4>
                        <ul class="space-y-2">
                            <template x-for="news in stock.recent_news?.slice(0, 3)" :key="news.title">
                                <li class="text-sm">
                                    <a :href="news.link" target="_blank" class="text-blue-400 hover:underline" x-text="news.title"></a>
                                    <span class="text-dark-600" x-text="' - ' + news.publisher + ', ' + news.date"></span>
                                </li>
                            </template>
                        </ul>
                    </div>

                    <!-- Insider activity -->
                    <div x-show="stock.insider_activity?.length" class="border-t border-dark-800 pt-4 mt-4">
                        <h4 class="text-sm font-semibold text-dark-400 mb-2">üëî Recent Insider Activity</h4>
                        <ul class="space-y-1">
                            <template x-for="activity in stock.insider_activity?.slice(0, 3)" :key="activity.date + activity.insider">
                                <li class="text-sm">
                                    <span :class="activity.type === 'buy' ? 'text-green-400' : 'text-red-400'" x-text="activity.type === 'buy' ? '‚ñ≤ Buy' : '‚ñº Sell'"></span>
                                    <span class="text-dark-300" x-text="' - ' + activity.insider"></span>
                                    <span x-show="activity.value" class="text-dark-500" x-text="' ($' + (activity.value / 1000000).toFixed(1) + 'M)'"></span>
                                    <span class="text-dark-600" x-text="' - ' + activity.date"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function reportData() {
    return {
        report: null,
        loading: true,
        error: null,
        viewMode: 'cards',
        sortColumn: 'rank',
        sortDirection: 'asc',
        generating: false,
        generateMessage: null,

        async loadLatestReport() {
            try {
                const response = await fetch('/api/reports/latest');
                if (!response.ok) {
                    throw new Error('No report available yet');
                }
                this.report = await response.json();
            } catch (e) {
                this.error = e.message;
            } finally {
                this.loading = false;
            }
        },

        async generateReport() {
            if (this.generating) return;

            this.generating = true;
            this.generateMessage = null;

            try {
                const response = await fetch('/api/reports/generate-full');
                const data = await response.json();

                if (data.status === 'started') {
                    // Show message and poll for completion
                    this.generateMessage = 'Report generation started. This may take a few minutes...';

                    // Poll every 10 seconds to check if new report is ready
                    const pollInterval = setInterval(async () => {
                        try {
                            const checkResponse = await fetch('/api/reports/latest');
                            if (checkResponse.ok) {
                                const newReport = await checkResponse.json();
                                // Check if this is a newer report
                                if (!this.report || newReport.id !== this.report.id) {
                                    this.report = newReport;
                                    this.generating = false;
                                    this.generateMessage = null;
                                    clearInterval(pollInterval);
                                }
                            }
                        } catch (e) {
                            // Ignore polling errors
                        }
                    }, 10000);

                    // Stop polling after 10 minutes max
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        if (this.generating) {
                            this.generating = false;
                            this.generateMessage = 'Report generation is taking longer than expected. Refresh the page later.';
                        }
                    }, 600000);
                }
            } catch (e) {
                this.generating = false;
                this.generateMessage = 'Error starting report generation: ' + e.message;
            }
        },

        sortBy(column) {
            if (this.sortColumn === column) {
                // Toggle direction if same column
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, set to ascending (or descending for numeric columns where higher is usually better)
                this.sortColumn = column;
                // Default to descending for returns and signals (higher = better)
                if (['three_month_return', 'one_year_return', 'bullish_signals'].includes(column)) {
                    this.sortDirection = 'desc';
                } else {
                    this.sortDirection = 'asc';
                }
            }
        },

        get sortedStocks() {
            if (!this.report?.stocks) return [];

            const stocks = [...this.report.stocks];
            const column = this.sortColumn;
            const direction = this.sortDirection;

            return stocks.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle null/undefined values - push them to the end
                if (aVal == null && bVal == null) return 0;
                if (aVal == null) return 1;
                if (bVal == null) return -1;

                // String comparison for ticker and sentiment
                if (column === 'ticker' || column === 'sentiment_label') {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    if (direction === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                }

                // Numeric comparison
                if (direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        },

        formatTimestamp(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffHours < 24) return diffHours + 'h ago';
            if (diffDays < 7) return diffDays + 'd ago';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },

        formatVolume(vol) {
            if (!vol) return 'N/A';
            if (vol >= 1e9) return (vol / 1e9).toFixed(1) + 'B';
            if (vol >= 1e6) return (vol / 1e6).toFixed(1) + 'M';
            if (vol >= 1e3) return (vol / 1e3).toFixed(0) + 'K';
            return vol.toString();
        }
    }
}
</script>
{% endblock %}
