{% extends "base.html" %}

{% block title %}Watchlist - Stock Talk{% endblock %}

{% block content %}
<div x-data="watchlistApp()">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">My Watchlist</h1>
        <p class="text-dark-400">Add stocks to always include them in the daily analysis report.</p>
    </div>

    <!-- Add Stock Form -->
    <div class="bg-dark-800 rounded-xl p-6 mb-8">
        <h2 class="text-xl font-semibold text-white mb-4">Add Stock to Watchlist</h2>
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
                <label class="block text-sm text-dark-400 mb-1">Ticker Symbol</label>
                <input
                    type="text"
                    x-model="newTicker"
                    @keydown.enter="addStock()"
                    placeholder="e.g., AAPL"
                    class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2 text-white uppercase focus:outline-none focus:border-blue-500"
                    maxlength="10"
                >
            </div>
            <div class="flex-1">
                <label class="block text-sm text-dark-400 mb-1">Notes (optional)</label>
                <input
                    type="text"
                    x-model="newNotes"
                    @keydown.enter="addStock()"
                    placeholder="Why are you watching this stock?"
                    class="w-full bg-dark-900 border border-dark-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500"
                >
            </div>
            <div class="flex items-end">
                <button
                    @click="addStock()"
                    :disabled="!newTicker.trim() || loading"
                    class="px-6 py-2 bg-green-700 hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-white font-medium transition-colors"
                >
                    <span x-show="!loading">Add Stock</span>
                    <span x-show="loading">Adding...</span>
                </button>
            </div>
        </div>
        <div x-show="error" x-cloak class="mt-4 text-red-400 text-sm" x-text="error"></div>
        <div x-show="success" x-cloak class="mt-4 text-green-400 text-sm" x-text="success"></div>
    </div>

    <!-- Watchlist Table -->
    <div class="bg-dark-800 rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-dark-700">
            <h2 class="text-xl font-semibold text-white">
                Watchlist Stocks
                <span class="text-dark-400 text-base font-normal" x-text="'(' + stocks.length + ')'"></span>
            </h2>
        </div>

        <!-- Loading State -->
        <div x-show="loadingList" class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        </div>

        <!-- Empty State -->
        <div x-show="!loadingList && stocks.length === 0" class="text-center py-12">
            <div class="text-4xl mb-4">ðŸ“‹</div>
            <p class="text-dark-400">No stocks in your watchlist yet.</p>
            <p class="text-dark-500 text-sm mt-2">Add stocks above to always include them in daily reports.</p>
        </div>

        <!-- Stock List -->
        <div x-show="!loadingList && stocks.length > 0">
            <table class="w-full">
                <thead class="bg-dark-900/50">
                    <tr class="text-left text-dark-400 text-sm">
                        <th class="px-6 py-3">Ticker</th>
                        <th class="px-6 py-3">Notes</th>
                        <th class="px-6 py-3">Added</th>
                        <th class="px-6 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-dark-700">
                    <template x-for="stock in stocks" :key="stock.id">
                        <tr class="hover:bg-dark-700/50 transition-colors">
                            <td class="px-6 py-4">
                                <a :href="'/stock/' + stock.ticker" class="text-blue-400 hover:text-blue-300 font-semibold" x-text="stock.ticker"></a>
                            </td>
                            <td class="px-6 py-4 text-dark-300" x-text="stock.notes || '-'"></td>
                            <td class="px-6 py-4 text-dark-400 text-sm" x-text="formatDate(stock.created_at)"></td>
                            <td class="px-6 py-4 text-right">
                                <button
                                    @click="removeStock(stock.ticker)"
                                    class="text-red-400 hover:text-red-300 text-sm font-medium"
                                >
                                    Remove
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Info Box -->
    <div class="mt-8 bg-blue-900/20 border border-blue-700/50 rounded-xl p-6">
        <h3 class="text-lg font-semibold text-blue-300 mb-2">How Watchlist Works</h3>
        <ul class="text-dark-300 space-y-2 text-sm">
            <li>Stocks in your watchlist are <strong class="text-white">always included</strong> in the daily analysis, regardless of Reddit mentions.</li>
            <li>Watchlist stocks get <strong class="text-white">priority processing</strong> during report generation.</li>
            <li>The next report will include any stocks you add here (reports run at 9pm PT or manually via the homepage).</li>
        </ul>
    </div>
</div>

<script>
function watchlistApp() {
    return {
        stocks: [],
        newTicker: '',
        newNotes: '',
        loading: false,
        loadingList: true,
        error: '',
        success: '',

        async init() {
            await this.fetchWatchlist();
        },

        async fetchWatchlist() {
            this.loadingList = true;
            try {
                const response = await fetch('/api/watchlist');
                const data = await response.json();
                this.stocks = data.stocks || [];
            } catch (e) {
                console.error('Failed to fetch watchlist:', e);
            } finally {
                this.loadingList = false;
            }
        },

        async addStock() {
            const ticker = this.newTicker.trim().toUpperCase();
            if (!ticker) return;

            this.loading = true;
            this.error = '';
            this.success = '';

            try {
                const params = new URLSearchParams({ ticker });
                if (this.newNotes.trim()) {
                    params.append('notes', this.newNotes.trim());
                }

                const response = await fetch('/api/watchlist?' + params.toString(), {
                    method: 'POST'
                });

                const data = await response.json();

                if (!response.ok) {
                    this.error = data.detail || 'Failed to add stock';
                } else {
                    this.success = `${ticker} added to watchlist!`;
                    this.newTicker = '';
                    this.newNotes = '';
                    await this.fetchWatchlist();

                    // Clear success message after 3 seconds
                    setTimeout(() => { this.success = ''; }, 3000);
                }
            } catch (e) {
                this.error = 'Network error. Please try again.';
            } finally {
                this.loading = false;
            }
        },

        async removeStock(ticker) {
            if (!confirm(`Remove ${ticker} from watchlist?`)) return;

            try {
                const response = await fetch(`/api/watchlist/${ticker}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await this.fetchWatchlist();
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to remove stock');
                }
            } catch (e) {
                alert('Network error. Please try again.');
            }
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
    };
}
</script>
{% endblock %}
