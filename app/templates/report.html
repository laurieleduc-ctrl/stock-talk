{% extends "base.html" %}

{% block title %}Stock Talk - Report{% endblock %}

{% block content %}
<div x-data="reportData({{ report_id }})" x-init="loadReport()">
    <!-- Loading state -->
    <div x-show="loading" class="flex items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>

    <!-- Error state -->
    <div x-show="error && !loading" class="text-center py-20">
        <div class="text-6xl mb-4">üìä</div>
        <h2 class="text-2xl font-bold text-white mb-2">Report Not Found</h2>
        <p class="text-dark-400" x-text="error"></p>
        <a href="/history" class="text-blue-400 hover:underline mt-4 inline-block">‚Üê Back to History</a>
    </div>

    <!-- Report content (same as index.html but for specific report) -->
    <div x-show="report && !loading" x-cloak>
        <!-- Back link -->
        <a href="/history" class="text-dark-400 hover:text-white mb-4 inline-flex items-center">
            ‚Üê Back to History
        </a>

        <!-- Header -->
        <div class="mb-8 mt-4">
            <h1 class="text-3xl font-bold text-white" x-text="formatDate(report?.date)"></h1>
            <p class="text-dark-400 mt-1">
                <span x-text="report?.stocks?.length"></span> stocks selected from
                <span x-text="report?.stocks_analyzed"></span> analyzed
            </p>
        </div>

        <!-- Sector breakdown -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <template x-for="(count, sector) in report?.sector_breakdown" :key="sector">
                <div class="bg-dark-900 rounded-lg p-4 border border-dark-800">
                    <div class="text-2xl font-bold text-white" x-text="count"></div>
                    <div class="text-sm text-dark-400 capitalize" x-text="sector === 'ai' ? 'AI' : sector"></div>
                </div>
            </template>
        </div>

        <!-- Tip of the day -->
        <div x-show="report?.tip_of_the_day" class="bg-gradient-to-r from-blue-900/50 to-purple-900/50 rounded-lg p-6 mb-8 border border-blue-800/50">
            <div class="flex items-start space-x-4">
                <div class="text-3xl">üí°</div>
                <div>
                    <h3 class="text-lg font-semibold text-white" x-text="report?.tip_of_the_day?.title"></h3>
                    <p class="text-dark-300 mt-2" x-text="report?.tip_of_the_day?.content"></p>
                </div>
            </div>
        </div>

        <!-- Stocks cards -->
        <div class="space-y-6">
            <template x-for="stock in report?.stocks" :key="stock.ticker">
                <div
                    class="stock-card"
                    :class="stock.is_dark_horse ? 'dark-horse' : ''"
                >
                    <!-- Same card content as index.html -->
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-dark-500" x-text="'#' + stock.rank"></span>
                                <span x-show="stock.is_dark_horse" class="text-sm">üê¥ Dark Horse</span>
                            </div>
                            <h3 class="text-xl font-bold text-white mt-1">
                                <a :href="'/stock/' + stock.ticker" class="hover:text-blue-400" x-text="stock.ticker"></a>
                                <span class="text-dark-400 font-normal text-base ml-2" x-text="stock.name"></span>
                            </h3>
                            <div class="text-sm text-dark-500 mt-1">
                                <span x-text="stock.sector"></span> ‚Ä¢
                                <span class="capitalize" x-text="stock.sector_category === 'ai' ? 'AI' : stock.sector_category"></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-white" x-text="'$' + stock.price?.toFixed(2)"></div>
                            <div class="text-red-400 font-medium" x-text="stock.pct_from_ath?.toFixed(1) + '% off ATH'"></div>
                        </div>
                    </div>

                    <!-- Metrics grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="metric-box">
                            <div class="metric-label">P/E Ratio</div>
                            <div class="metric-value" x-text="stock.pe_ratio?.toFixed(1) || 'N/A'"></div>
                            <div class="metric-help">Price for each $1 of profit</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">P/B Ratio</div>
                            <div class="metric-value" x-text="stock.pb_ratio?.toFixed(2) || 'N/A'"></div>
                            <div class="metric-help">Price vs company assets</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">Debt/Equity</div>
                            <div class="metric-value" :class="stock.debt_to_equity < 0.5 ? 'text-green-400' : (stock.debt_to_equity > 1.5 ? 'text-red-400' : '')" x-text="stock.debt_to_equity?.toFixed(2) || 'N/A'"></div>
                            <div class="metric-help">Lower = less debt risk</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label">RSI</div>
                            <div class="metric-value" :class="stock.rsi < 30 ? 'text-green-400' : (stock.rsi > 70 ? 'text-red-400' : '')" x-text="stock.rsi?.toFixed(0) || 'N/A'"></div>
                            <div class="metric-help" x-text="stock.rsi < 30 ? 'Oversold' : (stock.rsi > 70 ? 'Overbought' : 'Neutral')"></div>
                        </div>
                    </div>

                    <!-- Buy case -->
                    <div class="bg-dark-800/50 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-green-400 mb-2">üí° Why It Might Be a Buy</h4>
                        <p class="text-dark-300 text-sm" x-text="stock.buy_case"></p>
                    </div>

                    <!-- Risk factors -->
                    <div class="bg-dark-800/50 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-red-400 mb-2">‚ö†Ô∏è Risks to Know</h4>
                        <ul class="text-dark-300 text-sm space-y-1">
                            <template x-for="risk in stock.risk_factors" :key="risk">
                                <li class="flex items-start">
                                    <span class="text-dark-600 mr-2">‚Ä¢</span>
                                    <span x-text="risk"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function reportData(reportId) {
    return {
        reportId: reportId,
        report: null,
        loading: true,
        error: null,

        async loadReport() {
            try {
                const response = await fetch(`/api/reports/${this.reportId}`);
                if (!response.ok) {
                    throw new Error('Report not found');
                }
                this.report = await response.json();
            } catch (e) {
                this.error = e.message;
            } finally {
                this.loading = false;
            }
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    }
}
</script>
{% endblock %}
